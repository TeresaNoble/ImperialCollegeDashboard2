<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Imperial College Research Dashboard (Live Dimensions Data)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f9fafc; }
    h1 { color: #003366; }
    .card { background: #fff; padding: 15px; margin: 10px 0; border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .flex { display: flex; gap: 20px; flex-wrap: wrap; }
    .tag { background: #007bff; color: white; padding: 5px 10px; margin: 3px;
           border-radius: 4px; cursor: pointer; display: inline-block; }
    .tag:hover { background: #0056b3; }
    input, select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
    input { width: 250px; }
    button { padding: 8px 12px; border: none; background: #007bff; color: white; border-radius: 4px; cursor: pointer; }
    button:hover { background: #0056b3; }
    #theme-modal { display:none; position:fixed; top:5%; left:10%; width:80%; height:85%;
                   background:white; border:1px solid #ccc; overflow:auto; padding:20px; z-index:1000; }
    #theme-modal h2 { margin-top:0; }
    #close-modal { float:right; cursor:pointer; color:red; font-weight:bold; }
  </style>
</head>
<body>

  <h1>ğŸŒ Imperial College Research Dashboard (Live from Dimensions)</h1>
  <p>Explore global research topics and Imperialâ€™s contributions â€” using live Dimensions data.</p>

  <div class="card">
    <input type="text" id="search-term" placeholder="Enter keyword (e.g. wildfire, malaria)">
    <select id="period-select">
      <option value="all">All years</option>
      <option value="1">Last 1 year</option>
      <option value="5">Last 5 years</option>
    </select>
    <button id="search-btn">Search</button>
  </div>

  <div id="dashboard-content" style="display:none;">
    <div class="flex">
      <div class="card" style="flex:1">
        <h2>ğŸŒ Global Publications</h2>
        <p id="global-count"></p>
        <p><strong>Hot topics:</strong> <span id="global-topics"></span></p>
      </div>
      <div class="card" style="flex:1">
        <h2>ğŸ“ Imperial Publications</h2>
        <p id="imperial-count"></p>
        <p><strong>Imperial themes:</strong> <span id="imperial-themes"></span></p>
      </div>
    </div>

    <div class="card">
      <h2>ğŸ“ˆ Publications Trend</h2>
      <canvas id="combinedChart"></canvas>
      <p id="trend-narrative" class="narrative"></p>
    </div>

    <div class="card">
      <h2>ğŸ”¥ Research Themes</h2>
      <div id="theme-tags"></div>
    </div>

    <div class="card">
      <h2>ğŸ“„ Top Papers</h2>
      <h3>ğŸŒ Global Top Papers</h3>
      <div id="top-papers-global"></div>
      <h3>ğŸ“ Imperial Top Papers</h3>
      <div id="top-papers-imperial"></div>
    </div>

    <div class="card">
      <h2>ğŸš€ Opportunities for Imperial</h2>
      <p id="imperial-opportunities" class="narrative"></p>
    </div>
  </div>

  <!-- Modal -->
  <div id="theme-modal">
    <span id="close-modal">âœ–</span>
    <h2 id="theme-title"></h2>
    <p id="theme-summary" class="narrative"></p>
    <canvas id="theme-trend"></canvas>
    <div id="theme-papers"></div>
  </div>

<script>
document.addEventListener("DOMContentLoaded", () => {

  function safeValue(v, fallback="N/A") {
    return (v !== null && v !== undefined && v !== "NaN") ? v : fallback;
  }

  const conceptConvergenceLookup = new Map([
    ["C2779951507", { theme: "Climate & Environment", description: "Climate resilience, sustainability and environmental stewardship" }],
    ["C2886692312", { theme: "Health & Medicine", description: "Translational health innovation and public health impact" }],
    ["C2799971186", { theme: "AI, Data & Digital", description: "Advanced analytics, automation and data-driven innovation" }],
    ["C2793553830", { theme: "Future of Industry", description: "Next-generation materials, manufacturing and energy systems" }],
    ["C2965165064", { theme: "Society & Policy", description: "Inclusive innovation, governance and social impact" }],
    // Fallback entries matched by normalized concept labels
    ["climate change", { theme: "Climate & Environment", description: "Climate resilience, sustainability and environmental stewardship" }],
    ["public health", { theme: "Health & Medicine", description: "Translational health innovation and public health impact" }],
    ["artificial intelligence", { theme: "AI, Data & Digital", description: "Advanced analytics, automation and data-driven innovation" }],
    ["energy transition", { theme: "Future of Industry", description: "Next-generation materials, manufacturing and energy systems" }],
    ["social innovation", { theme: "Society & Policy", description: "Inclusive innovation, governance and social impact" }]
  ]);

  function resolveConvergenceTheme(concept) {
    if (!concept) return null;
    const normalized = (concept.label || "").toLowerCase();
    return conceptConvergenceLookup.get(concept.id) ||
           conceptConvergenceLookup.get(normalized) || null;
  }

  function collectConceptThemes(papers, { max = 8, minRelevance = 0.2 } = {}) {
    const conceptStats = new Map();

    papers.forEach(paper => {
      const seenForPaper = new Set();
      const concepts = [];
      if (Array.isArray(paper.concepts)) concepts.push(...paper.concepts);
      if (Array.isArray(paper.fields_of_study)) concepts.push(...paper.fields_of_study);

      concepts.forEach(concept => {
        if (!concept) return;
        const label = concept.name || concept.display_name || concept.label || concept.title;
        if (!label) return;
        const key = concept.id || label.toLowerCase();
        if (!key || seenForPaper.has(key)) return;
        seenForPaper.add(key);

        const relevanceCandidate = typeof concept.relevance === "number" ? concept.relevance : concept.score;
        const relevance = (typeof relevanceCandidate === "number" && !Number.isNaN(relevanceCandidate)) ? Math.max(relevanceCandidate, 0) : 1;
        if (relevance === 0) return;

        const entry = conceptStats.get(key) || { id: concept.id || key, label, totalRelevance: 0, count: 0 };
        entry.totalRelevance += relevance;
        entry.count += 1;
        entry.label = label;
        conceptStats.set(key, entry);
      });
    });

    const enriched = Array.from(conceptStats.values()).map(stat => ({
      ...stat,
      averageRelevance: stat.count ? stat.totalRelevance / stat.count : 0
    }));

    const filtered = enriched.filter(stat => stat.averageRelevance >= minRelevance);
    const candidates = (filtered.length ? filtered : enriched)
      .sort((a, b) => (b.totalRelevance || 0) - (a.totalRelevance || 0));

    return candidates.slice(0, max);
  }

  function buildWhereClause(filters = []) {
    const clauses = filters.filter(Boolean);
    return clauses.length ? ` where ${clauses.join(" and ")}` : "";
  }

  async function callDSL(q) {
    try {
      const r = await fetch("/api/dimensions", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({query: q})
      });
      const data = await r.json();
      console.log("ğŸ” DSL Query Result:", data);
      return data;
    } catch (e) {
      console.error("âš ï¸ DSL call failed", e);
      return [];
    }
  }

  // --- Imperial ID ---
  let imperialId = null;
  async function getImperialId() {
    if (imperialId) return imperialId;
    const q = `
      search organizations for "Imperial College London"
      return organizations[id + name] limit 5
    `;
    const res = await callDSL(q);
    if (res.organizations && res.organizations.length)
      imperialId = res.organizations[0].id;
    return imperialId;
  }

  // --- Client-side aggregation of publications per year ---
  async function getGlobalCounts(term, period, conceptId = null) {
    const year = new Date().getFullYear();
    const filters = [];
    if (period === "1") filters.push(`year >= ${year - 1}`);
    if (period === "5") filters.push(`year >= ${year - 5}`);
    if (conceptId) filters.push(`concepts.id = "${conceptId}"`);
    const query = `
      search publications for "${term}"${buildWhereClause(filters)}
      return publications[year] limit 1000
    `;
    const r = await callDSL(query);
    let pubs = r.publications || r || [];
    if (!Array.isArray(pubs)) pubs = [];
    const counts = {};
    pubs.forEach(p => { if (p.year) counts[p.year] = (counts[p.year] || 0) + 1; });
    return Object.entries(counts).map(([y,c]) => ({year: +y, count:c})).sort((a,b)=>a.year-b.year);
  }

async function getImperialCounts(term, period, orgIdOverride = null, conceptId = null) {
  const year = new Date().getFullYear();
  const filters = [];
  if (period === "1") filters.push(`year >= ${year - 1}`);
  if (period === "5") filters.push(`year >= ${year - 5}`);

  // Use known Imperial identifiers
  const orgId = orgIdOverride || "grid.4991.5"; // Imperial College London GRID ID
  const orgName = "Imperial College London";

  filters.push(`(research_orgs.id = "${orgId}" or research_orgs.name = "${orgName}")`);
  if (conceptId) filters.push(`concepts.id = "${conceptId}"`);

  const query = `
    search publications for "${term}"${buildWhereClause(filters)}
    return publications[year] limit 1000
  `;
  const r = await callDSL(query);

  let pubs = r.publications || r || [];
  if (!Array.isArray(pubs)) pubs = [];

  const counts = {};
  pubs.forEach(p => { if (p.year) counts[p.year] = (counts[p.year] || 0) + 1; });
  return Object.entries(counts)
    .map(([y, c]) => ({ year: +y, count: c }))
    .sort((a, b) => a.year - b.year);
}


  // --- Top papers ---
  async function getTopPapers(term, period, orgFilters = [], limit = 5, conceptId = null) {
    const year = new Date().getFullYear();
    const filters = [];
    if (period === "1") filters.push(`year >= ${year - 1}`);
    if (period === "5") filters.push(`year >= ${year - 5}`);

    if (!Array.isArray(orgFilters)) {
      if (orgFilters) filters.push(orgFilters);
    } else {
      filters.push(...orgFilters.filter(Boolean));
    }
    if (conceptId) filters.push(`concepts.id = "${conceptId}"`);

    const query = `
      search publications for "${term}"${buildWhereClause(filters)}
      return publications[title + year + times_cited + altmetric + authors + research_orgs + linkout + concepts + fields_of_study]
      sort by times_cited limit ${limit}
    `;
    const r = await callDSL(query);
    return r.publications || [];
  }

  // --- Search button ---
  document.getElementById("search-btn").onclick = async () => {
    const term = document.getElementById("search-term").value.trim();
    const period = document.getElementById("period-select").value;
    if (!term) return alert("Enter a keyword first.");

    document.getElementById("dashboard-content").style.display = "none";
    document.body.insertAdjacentHTML("beforeend","<p id='loading'>Loading data from Dimensions...</p>");

    const orgId = await getImperialId();
    const imperialOrgFilter = `(research_orgs.id = "${orgId}" or research_orgs.name = "Imperial College London")`;
    const [globalAgg, imperialAgg, topGlobal, topImperial] = await Promise.all([
      getGlobalCounts(term, period),
      getImperialCounts(term, period, orgId),
      getTopPapers(term, period, [], 5),
      getTopPapers(term, period, [imperialOrgFilter], 5)
    ]);

    document.getElementById("loading").remove();
    document.getElementById("dashboard-content").style.display = "block";

    const years = [...new Set([...globalAgg, ...imperialAgg].map(d => d.year))]
      .sort((a, b) => a - b);
    const gCounts = years.map(y => (globalAgg.find(d=>d.year===y)?.count)||0);
    const iCounts = years.map(y => (imperialAgg.find(d=>d.year===y)?.count)||0);

    const totalGlobal = d3.sum(gCounts);
    const totalImperial = d3.sum(iCounts);
    const pct = totalGlobal ? ((totalImperial/totalGlobal)*100).toFixed(1) : 0;

    document.getElementById("global-count").innerText = `${totalGlobal} publications`;
    document.getElementById("imperial-count").innerText = `${totalImperial} publications (${pct}% of global)`;

    if (window.mainTrendChart) {
      window.mainTrendChart.destroy();
    }
    const combinedCtx = document.getElementById('combinedChart').getContext('2d');
    window.mainTrendChart = new Chart(combinedCtx, {
      type: 'line',
      data: {
        labels: years,
        datasets: [
          { label: 'Global Publications', data: gCounts, borderColor: 'blue', fill: false },
          { label: 'Imperial Publications', data: iCounts, borderColor: 'green', fill: false }
        ]
      },
      options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });

    document.getElementById("trend-narrative").innerText =
      `Imperialâ€™s publication activity compared to global research on "${term}".`;
    const conceptThemes = collectConceptThemes([...topGlobal, ...topImperial]);
    const topConceptLabels = conceptThemes.map(c => c.label);
    const combinedConceptText = topConceptLabels.join(", ");
    document.getElementById("global-topics").innerText = combinedConceptText || "Various";
    document.getElementById("imperial-themes").innerText = combinedConceptText || "Various";


    function render(divId, papers) {
      const div = document.querySelector(divId);
      div.innerHTML = "";
      papers.forEach(p => {
        const authors = (p.authors||[]).map(a => a.first_name?`${a.first_name} ${a.last_name}`:a).join(", ");
        div.innerHTML += `<p><b>${safeValue(p.title)}</b><br>
          Year: ${safeValue(p.year)} | Citations: ${safeValue(p.times_cited,0)} | Altmetric: ${safeValue(p.altmetric,0)}<br>
          <em>Authors:</em> ${safeValue(authors)}<br>
          <a href="${safeValue(p.linkout,'#')}" target="_blank">View in Dimensions</a></p>`;
      });
    }
    render("#top-papers-global", topGlobal);
    render("#top-papers-imperial", topImperial);

    document.getElementById("imperial-opportunities").innerText =
      `Imperial shows strong output but could expand collaboration on related ${term} research topics.`;

    const themeDiv = d3.select("#theme-tags");
    themeDiv.html("");
    if (conceptThemes.length === 0) {
      themeDiv.append("span").text("Concept insights unavailable for this search.");
    } else {
      conceptThemes.forEach(theme => themeDiv.append("span")
        .attr("class","tag")
        .attr("data-concept-id", theme.id)
        .text(theme.label)
        .on("click", () => showTheme(theme, period, orgId)));
    }
  };

  async function showTheme(concept, period, orgId) {
    const modal = document.getElementById("theme-modal");
    modal.style.display = "block";
    document.getElementById("theme-title").innerText = `Theme: ${concept.label}`;

    const [globalAgg, imperialAgg, topGlobal] = await Promise.all([
      getGlobalCounts(concept.label, period, concept.id),
      getImperialCounts(concept.label, period, orgId, concept.id),
      getTopPapers(concept.label, period, [], 5, concept.id)
    ]);

    const years = [...new Set(globalAgg.map(d=>d.year))].sort();
    const gCounts = years.map(y => (globalAgg.find(d=>d.year===y)?.count)||0);
    const iCounts = years.map(y => (imperialAgg.find(d=>d.year===y)?.count)||0);

    const globalTotal = d3.sum(gCounts);
    const imperialTotal = d3.sum(iCounts);
    const convergenceDetails = resolveConvergenceTheme(concept);
    const summaryParts = [
      `${globalTotal} global publications on ${concept.label} (Dimensions concept ${concept.id}).`,
      `Imperial contributed ${imperialTotal}.`
    ];
    if (convergenceDetails) {
      summaryParts.push(`Linked Imperial convergence theme: ${convergenceDetails.theme}${convergenceDetails.description ? ` â€” ${convergenceDetails.description}.` : "."}`);
    }
    document.getElementById("theme-summary").innerText = summaryParts.join(" ");

    // Destroy old chart if it exists
    if (window.themeTrendChart) {
      window.themeTrendChart.destroy();
    }

    const themeCtx = document.getElementById('theme-trend').getContext('2d');
    window.themeTrendChart = new Chart(themeCtx, {
      type: 'line',
      data: {
        labels: years,
        datasets: [
          { label: 'Global Publications', data: gCounts, borderColor: 'blue', fill: false },
          { label: 'Imperial Publications', data: iCounts, borderColor: 'green', fill: false }
        ]
      },
      options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });


    const div = document.getElementById("theme-papers");
    div.innerHTML = topGlobal.map(p=>`
      <p><b>${safeValue(p.title)}</b> (${safeValue(p.year)})<br>
      Citations: ${safeValue(p.times_cited)} | Altmetric: ${safeValue(p.altmetric)}<br>
      <a href="${safeValue(p.linkout,'#')}" target="_blank">View in Dimensions</a></p>
    `).join("");
  }

  document.getElementById("close-modal").onclick = () =>
    document.getElementById("theme-modal").style.display="none";

});
</script>
</body>
</html>
