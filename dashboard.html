<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Imperial College Research Dashboard (Live Dimensions Data)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f9fafc; }
    h1 { color: #003366; }
    .card { background: #fff; padding: 15px; margin: 10px 0; border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .flex { display: flex; gap: 20px; flex-wrap: wrap; }
    .tag { background: #007bff; color: white; padding: 5px 10px; margin: 3px;
           border-radius: 4px; cursor: pointer; display: inline-block; }
    .tag:hover { background: #0056b3; }
    input, select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
    input { width: 250px; }
    button { padding: 8px 12px; border: none; background: #007bff; color: white; border-radius: 4px; cursor: pointer; }
    button:hover { background: #0056b3; }
    #theme-modal { display:none; position:fixed; top:5%; left:10%; width:80%; height:85%;
                   background:white; border:1px solid #ccc; overflow:auto; padding:20px; z-index:1000; }
    #theme-modal h2 { margin-top:0; }
    #close-modal { float:right; cursor:pointer; color:red; font-weight:bold; }
    .status-message { color: #555; font-style: italic; }
    .error-message { color: #b30000; font-weight: 600; }
    .opportunity-list { padding-left: 20px; }
    .opportunity-list li { margin-bottom: 12px; }
    .opportunity-header { display: flex; justify-content: space-between; align-items: baseline; gap: 12px; }
    .opportunity-header strong { color: #003366; }
    .confidence-chip { background: #e0f0ff; color: #004080; border-radius: 12px; padding: 2px 10px; font-size: 0.85rem; }
    .opportunity-metrics, .opportunity-collaborators { margin: 6px 0 0 0; padding-left: 16px; }
  </style>
</head>
<body>

  <h1>🌍 Imperial College Research Dashboard (Live from Dimensions)</h1>
  <p>Explore global research topics and Imperial’s contributions — using live Dimensions data.</p>

  <div class="card">
    <input type="text" id="search-term" placeholder="Enter keyword (e.g. wildfire, malaria)">
    <select id="period-select">
      <option value="all">All years</option>
      <option value="1">Last 1 year</option>
      <option value="5">Last 5 years</option>
    </select>
    <button id="search-btn">Search</button>
  </div>

  <div id="dashboard-content" style="display:none;">
    <div class="flex">
      <div class="card" style="flex:1">
        <h2>🌐 Global Publications</h2>
        <p id="global-count"></p>
        <p><strong>Hot topics:</strong> <span id="global-topics"></span></p>
      </div>
      <div class="card" style="flex:1">
        <h2>🎓 Imperial Publications</h2>
        <p id="imperial-count"></p>
        <p><strong>Imperial themes:</strong> <span id="imperial-themes"></span></p>
      </div>
    </div>

    <div class="card">
      <h2>📈 Publications Trend</h2>
      <canvas id="combinedChart"></canvas>
      <p id="trend-narrative" class="narrative"></p>
    </div>

    <div class="card">
      <h2>🔥 Research Themes</h2>
      <div id="theme-tags"></div>
    </div>

    <div class="card">
      <h2>📄 Top Papers</h2>
      <h3>🌐 Global Top Papers</h3>
      <div id="top-papers-global"></div>
      <h3>🎓 Imperial Top Papers</h3>
      <div id="top-papers-imperial"></div>
    </div>

    <div class="card">
      <h2>🚀 Opportunities for Imperial</h2>
      <div id="imperial-opportunities" class="narrative status-message">Run a search to see AI-generated opportunity signals.</div>
    </div>
  </div>

  <!-- Modal -->
  <div id="theme-modal">
    <span id="close-modal">✖</span>
    <h2 id="theme-title"></h2>
    <p id="theme-summary" class="narrative"></p>
    <canvas id="theme-trend"></canvas>
    <div id="theme-papers"></div>
  </div>

<script>
document.addEventListener("DOMContentLoaded", () => {

  function safeValue(v, fallback="N/A") {
    return (v !== null && v !== undefined && v !== "NaN") ? v : fallback;
  }

  function buildWhereClause(filters = []) {
    const clauses = filters.filter(Boolean);
    return clauses.length ? ` where ${clauses.join(" and ")}` : "";
  }

  async function callDSL(q) {
    try {
      const r = await fetch("/api/dimensions", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({query: q})
      });
      const data = await r.json();
      console.log("🔍 DSL Query Result:", data);
      return data;
    } catch (e) {
      console.error("⚠️ DSL call failed", e);
      return [];
    }
  }

  // --- Imperial ID ---
  let imperialId = null;
  async function getImperialId() {
    if (imperialId) return imperialId;
    const q = `
      search organizations for "Imperial College London"
      return organizations[id + name] limit 5
    `;
    const res = await callDSL(q);
    if (res.organizations && res.organizations.length)
      imperialId = res.organizations[0].id;
    return imperialId;
  }

  // --- Client-side aggregation of publications per year ---
  async function getGlobalCounts(term, period) {
    const year = new Date().getFullYear();
    const filters = [];
    if (period === "1") filters.push(`year >= ${year - 1}`);
    if (period === "5") filters.push(`year >= ${year - 5}`);
    const query = `
      search publications for "${term}"${buildWhereClause(filters)}
      return publications[year] limit 1000
    `;
    const r = await callDSL(query);
    let pubs = r.publications || r || [];
    if (!Array.isArray(pubs)) pubs = [];
    const counts = {};
    pubs.forEach(p => { if (p.year) counts[p.year] = (counts[p.year] || 0) + 1; });
    return Object.entries(counts).map(([y,c]) => ({year: +y, count:c})).sort((a,b)=>a.year-b.year);
  }

async function getImperialCounts(term, period, orgIdOverride = null) {
  const year = new Date().getFullYear();
  const filters = [];
  if (period === "1") filters.push(`year >= ${year - 1}`);
  if (period === "5") filters.push(`year >= ${year - 5}`);

  // Use known Imperial identifiers
  const orgId = orgIdOverride || "grid.4991.5"; // Imperial College London GRID ID
  const orgName = "Imperial College London";

  filters.push(`(research_orgs.id = "${orgId}" or research_orgs.name = "${orgName}")`);

  const query = `
    search publications for "${term}"${buildWhereClause(filters)}
    return publications[year] limit 1000
  `;
  const r = await callDSL(query);

  let pubs = r.publications || r || [];
  if (!Array.isArray(pubs)) pubs = [];

  const counts = {};
  pubs.forEach(p => { if (p.year) counts[p.year] = (counts[p.year] || 0) + 1; });
  return Object.entries(counts)
    .map(([y, c]) => ({ year: +y, count: c }))
    .sort((a, b) => a.year - b.year);
}


  // --- Top papers ---
  async function getTopPapers(term, period, orgFilters = [], limit = 5) {
    const year = new Date().getFullYear();
    const filters = [];
    if (period === "1") filters.push(`year >= ${year - 1}`);
    if (period === "5") filters.push(`year >= ${year - 5}`);

    if (!Array.isArray(orgFilters)) {
      if (orgFilters) filters.push(orgFilters);
    } else {
      filters.push(...orgFilters.filter(Boolean));
    }

    const query = `
      search publications for "${term}"${buildWhereClause(filters)}
      return publications[title + year + times_cited + altmetric + authors + research_orgs + linkout]
      sort by times_cited limit ${limit}
    `;
    const r = await callDSL(query);
    return r.publications || [];
  }

  // --- Search button ---
  document.getElementById("search-btn").onclick = async () => {
    const term = document.getElementById("search-term").value.trim();
    const period = document.getElementById("period-select").value;
    if (!term) return alert("Enter a keyword first.");

    const dashboardContent = document.getElementById("dashboard-content");
    dashboardContent.style.display = "none";

    const existingLoading = document.getElementById("loading");
    if (existingLoading) existingLoading.remove();
    document.body.insertAdjacentHTML("beforeend", "<p id='loading'>Loading data from Dimensions...</p>");

    const opportunitiesContainer = document.getElementById("imperial-opportunities");
    const resetOpportunityCard = (message, asStatus = true) => {
      opportunitiesContainer.classList.toggle("status-message", Boolean(asStatus));
      opportunitiesContainer.classList.toggle("error-message", !asStatus);
      opportunitiesContainer.innerHTML = message;
    };
    resetOpportunityCard("Analysing opportunity signals...", true);

    const removeLoadingIndicator = () => {
      const loadingEl = document.getElementById("loading");
      if (loadingEl) loadingEl.remove();
    };

    try {
      const orgId = await getImperialId();
      const imperialOrgFilter = `(research_orgs.id = "${orgId}" or research_orgs.name = "Imperial College London")`;
      const [globalAgg, imperialAgg, topGlobal, topImperial] = await Promise.all([
        getGlobalCounts(term, period),
        getImperialCounts(term, period, orgId),
        getTopPapers(term, period, [], 5),
        getTopPapers(term, period, [imperialOrgFilter], 5)
      ]);

      try {
        const aiResponse = await fetch("/api/opportunity-predictions", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ term, period })
        });

        if (!aiResponse.ok) {
          const err = await aiResponse.json().catch(() => ({}));
          throw new Error(err.error || `Prediction service returned ${aiResponse.status}`);
        }

        const aiData = await aiResponse.json();
        const predictions = Array.isArray(aiData) ? aiData : (aiData.predictions || []);
        renderOpportunityPredictions(predictions);
      } catch (e) {
        console.error("⚠️ Prediction call failed", e);
        const fallback = (e && e.message) ? e.message : "Please try again later.";
        resetOpportunityCard(`Unable to load AI opportunity recommendations: ${fallback}`, false);
      }

      removeLoadingIndicator();
      dashboardContent.style.display = "block";

      const years = [...new Set([...globalAgg, ...imperialAgg].map(d => d.year))]
        .sort((a, b) => a - b);
      const gCounts = years.map(y => (globalAgg.find(d=>d.year===y)?.count)||0);
      const iCounts = years.map(y => (imperialAgg.find(d=>d.year===y)?.count)||0);

      const totalGlobal = d3.sum(gCounts);
      const totalImperial = d3.sum(iCounts);
      const pct = totalGlobal ? ((totalImperial/totalGlobal)*100).toFixed(1) : 0;

      document.getElementById("global-count").innerText = `${totalGlobal} publications`;
      document.getElementById("imperial-count").innerText = `${totalImperial} publications (${pct}% of global)`;

      if (window.mainTrendChart) {
        window.mainTrendChart.destroy();
      }
      const combinedCtx = document.getElementById('combinedChart').getContext('2d');
      window.mainTrendChart = new Chart(combinedCtx, {
        type: 'line',
        data: {
          labels: years,
          datasets: [
            { label: 'Global Publications', data: gCounts, borderColor: 'blue', fill: false },
            { label: 'Imperial Publications', data: iCounts, borderColor: 'green', fill: false }
          ]
        },
        options: { responsive: true, scales: { y: { beginAtZero: true } } }
      });

      document.getElementById("trend-narrative").innerText =
        `Imperial’s publication activity compared to global research on "${term}".`;
      const keywordSet = new Set();
      [...topGlobal, ...topImperial].forEach(p => {
        if (p.title) {
          p.title.toLowerCase().split(/\W+/).forEach(w => {
            if (w.length > 5) keywordSet.add(w);
          });
        }
      });
      const topics = Array.from(keywordSet).slice(0, 6);
      const topKeywords = topics.join(", ");
      document.getElementById("global-topics").innerText = topKeywords || "Various";
      document.getElementById("imperial-themes").innerText = topKeywords || "Various";


      function render(divId, papers) {
        const div = document.querySelector(divId);
        div.innerHTML = "";
        papers.forEach(p => {
          const authors = (p.authors||[]).map(a => a.first_name?`${a.first_name} ${a.last_name}`:a).join(", ");
          div.innerHTML += `<p><b>${safeValue(p.title)}</b><br>
            Year: ${safeValue(p.year)} | Citations: ${safeValue(p.times_cited,0)} | Altmetric: ${safeValue(p.altmetric,0)}<br>
            <em>Authors:</em> ${safeValue(authors)}<br>
            <a href="${safeValue(p.linkout,'#')}" target="_blank">View in Dimensions</a></p>`;
        });
      }
      render("#top-papers-global", topGlobal);
      render("#top-papers-imperial", topImperial);

      const themeDiv = d3.select("#theme-tags");
      themeDiv.html("");
      topics.forEach(t => themeDiv.append("span").attr("class","tag").text(t)
        .on("click", ()=> showTheme(t, period, orgId)));
    } catch (error) {
      console.error("⚠️ Dashboard refresh failed", error);
      removeLoadingIndicator();
      resetOpportunityCard("Unable to load dashboard data. Please try again.", false);
    }
  };

  function renderOpportunityPredictions(predictions) {
    const container = document.getElementById("imperial-opportunities");
    container.classList.remove("error-message");

    if (!predictions.length) {
      container.classList.add("status-message");
      container.innerHTML = "No AI recommendations were returned for this query yet.";
      return;
    }

    container.classList.remove("status-message");
    const listItems = predictions
      .sort((a, b) => (a.rank || 0) - (b.rank || 0))
      .map(prediction => {
        const confidence = Math.round((prediction.confidence || 0) * 100);
        const metrics = Object.entries(prediction.supporting_metrics || {})
          .map(([label, value]) => `<li><strong>${label.replace(/_/g, ' ')}:</strong> ${safeValue(value)}</li>`)
          .join("");

        const collaborators = (prediction.recommended_collaborators || [])
          .map(collab => {
            const name = safeValue(collab.name);
            const url = safeValue(collab.profile_url, "#");
            return `<li><a href="${url}" target="_blank" rel="noopener">${name}</a></li>`;
          })
          .join("");

        return `
          <li>
            <div class="opportunity-header">
              <strong>#${safeValue(prediction.rank)} · ${safeValue(prediction.challenge)}</strong>
              <span class="confidence-chip">Confidence: ${confidence}%</span>
            </div>
            ${metrics ? `<ul class="opportunity-metrics">${metrics}</ul>` : ""}
            ${collaborators ? `<div><em>Recommended collaborators</em><ul class="opportunity-collaborators">${collaborators}</ul></div>` : ""}
          </li>
        `;
      })
      .join("");

    container.innerHTML = `<ol class="opportunity-list">${listItems}</ol>`;
  }

  async function showTheme(theme, period, orgId) {
    const modal = document.getElementById("theme-modal");
    modal.style.display = "block";
    document.getElementById("theme-title").innerText = `Theme: ${theme}`;

    const [globalAgg, imperialAgg, topGlobal] = await Promise.all([
      getGlobalCounts(theme, period),
      getImperialCounts(theme, period, orgId),
      getTopPapers(theme, period, [], 5)
    ]);

    const years = [...new Set(globalAgg.map(d=>d.year))].sort();
    const gCounts = years.map(y => (globalAgg.find(d=>d.year===y)?.count)||0);
    const iCounts = years.map(y => (imperialAgg.find(d=>d.year===y)?.count)||0);

    document.getElementById("theme-summary").innerText =
      `${d3.sum(gCounts)} global publications on ${theme}, including ${d3.sum(iCounts)} from Imperial.`;

    // Destroy old chart if it exists
    if (window.themeTrendChart) {
      window.themeTrendChart.destroy();
    }

    const themeCtx = document.getElementById('theme-trend').getContext('2d');
    window.themeTrendChart = new Chart(themeCtx, {
      type: 'line',
      data: {
        labels: years,
        datasets: [
          { label: 'Global Publications', data: gCounts, borderColor: 'blue', fill: false },
          { label: 'Imperial Publications', data: iCounts, borderColor: 'green', fill: false }
        ]
      },
      options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });


    const div = document.getElementById("theme-papers");
    div.innerHTML = topGlobal.map(p=>`
      <p><b>${safeValue(p.title)}</b> (${safeValue(p.year)})<br>
      Citations: ${safeValue(p.times_cited)} | Altmetric: ${safeValue(p.altmetric)}<br>
      <a href="${safeValue(p.linkout,'#')}" target="_blank">View in Dimensions</a></p>
    `).join("");
  }

  document.getElementById("close-modal").onclick = () =>
    document.getElementById("theme-modal").style.display="none";

});
</script>
</body>
</html>
